<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />


	<title>Better Photo Search for MacOS with Clarifai · 28mm.github.io</title>

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:title" content="Better Photo Search for MacOS with Clarifai" />
<meta name="twitter:description" content="">

<meta name="description" content="">



<link rel="icon" href="/assets/favicon.png">
<link rel="apple-touch-icon" href="/assets/touch-icon.png">
<link rel="stylesheet" href="/assets/core.css">
<link rel="canonical" href="/notes/better-photo-search-for-macos">
<link rel="alternate" type="application/atom+xml" title="28mm.github.io" href="/feed.xml" />




<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


	</head>

	<body>

		<aside class="logo">

	

	<a href="/">
		<img src="http://www.gravatar.com/avatar/f9ca90ff91459baa73f9be03289a7c80.png?s=80" class="gravatar">
	</a>
	<span class="logo-prompt">Back to Home</span>

</aside>


		<main>
			<article>

	<div class="center">
		<h1>Better Photo Search for MacOS with Clarifai</h1>
		<time>February 19, 2018</time>
	</div>

<div class="divider"></div> 
	<script src="/assets/terraform-graphs-4/jquery.slim.min.js"></script>

<script src="https://d3js.org/d3.v4.js"></script>

<script src="/assets/terraform-graphs-4/d3-tip.js"></script>

<script src="/assets/mac-photos-2/coincidence.js"></script>

<script src="/assets/mac-photos-2/selectize.min.js"></script>

<script src="/assets/terraform-graphs-4/fontawesome-all.min.js"></script>

<link rel="stylesheet" type="text/css" href="/assets/terraform-graphs-4/selectize.css" />

<style>

.clarifai {
  background-color: #1b9e77;
  padding: 5px;
  margin: 2px;
}

.photos {
  background-color: #d95f02;
  padding: 5px;
  margin: 2px;
}

.rekognition {
  background-color: #7570b3;
  padding: 5px;
  margin: 2px;
}
</style>

<h3 id="introduction">Introduction</h3>

<p>I’ve previously written about <a href="/notes/osx-photo-search">a method of enabling Spotlight search of Photos.app libraries</a><sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> using tags generated by <code class="highlighter-rouge">photoanalysisd</code> that are otherwise only available through <em>Photos.app.</em></p>

<p>But <code class="highlighter-rouge">photoanalysisd</code> is limited to something like 1,000 unique subjects, while some commercial services advertise  recognition of 10x that number, and might be expected to produce more relevant tags.</p>

<p>This post considers commercial alternatives to <code class="highlighter-rouge">photoanalysisd</code>, comparing their performance on the task of classifying pictures from my photo library.</p>

<h3 id="no-useful-benchmarks">No Useful Benchmarks</h3>

<p>Commercial image classification services like Clarifai and Rekognition seem oddly reluctant to publish competitive benchmarks, which might help someone choose between them.</p>

<p>Some vendors tout performance in academic competitions like the ILSVRC, but this isn’t a direct test of their commercial offerings and is therefore only so useful.</p>

<p>Clarifai, however, do make <em>one</em> interesting claim about their general model: that it classifies 11,000 subjects. But is that a lot compared with Google, for instance? We don’t actually know.</p>

<p>(Nor do we know what those 11,000 subjects are and whether Clarifai reliably detects them.)</p>

<h3 id="simulated-search">Simulated Search</h3>

<p>To get a sense of how <em>Clarifai</em> compares with <em>Photos.app</em> on the task of classifying an individual’s Photo library, I submitted several thousand pictures from mine.</p>

<p>You can use the search field below to get a sense of the breadth and specifity of tags generated by each service, as well as the frequency with which particular tags occur.</p>

<p>Key: <span class="clarifai">Clarifai</span><span class="photos">Photos.app</span></p>

<p><select style="width: 100%" id="frequency-search"></select></p>

<p>Of course these are all pictures from my library, and therefore biased towards my interests. <a href="https://www.github.com/28mm/macos-photo-scripts">I’ve put code on GitHub if you are interested in doing a similar test, with your own photos.</a></p>

<p>Based on this experiment, and in view of my expectations, I’m impressed with the performance of Apple’s classifier. As I begin typing a query, Apple often seems to anticipate it with a relevant tag.</p>

<p>But Clarifai adds a great deal of breadth, even if some of the tags don’t correspond with likely search terms (e.g. “no person”).</p>

<p>So, it would be nice if Spotlight tags could be drawn from services like Clarifai and Rekognition as well as Photos.app.</p>

<h3 id="implementing-multi-vendor-tagging">Implementing Multi-Vendor Tagging</h3>

<p>The approach I settled on was to maintain a sqlite database seperate from <code class="highlighter-rouge">photos.db</code> that contains both the <code class="highlighter-rouge">photoanalysisd</code> tags and tags from 3rd-party services.</p>

<p>Find the tools referenced below on <a href="https://www.github.com/28mm/macos-photo-scripts">GitHub</a>.</p>

<p>Initialize a database (here: <code class="highlighter-rouge">new.db</code>), populating it with information about your Photos.app library, and synchronize the two.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">[...]$ </span>./alternative-classifiers.py --init              <span class="se">\</span>
            --db new.db                                 <span class="se">\</span>
            --photos-db ~/Pictures/..../photos.db       <span class="se">\</span>
            --lib ~/Pictures/..../library.photoslibrary <span class="se">\</span>
            --sync
</code></pre>
</div>

<p>(Please see the note <a href="https://www.github.com/28mm/macos-photo-scripts">here</a> about stopping <code class="highlighter-rouge">photolibraryd</code>, to release its lock on <code class="highlighter-rouge">photos.db</code>)</p>

<p>Then add tags from a 3rd-party service like Clarifai.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">[...]$ </span><span class="nb">export </span><span class="nv">CLARIFAI_API_KEY</span><span class="o">=</span><span class="s2">"YOUR_API_KEY_HERE"</span>
<span class="gp">[...]$ </span>./alternative-classifiers.py --db new.db --clarifai 
</code></pre>
</div>

<p>And finally, update the relevant xattrs, so that spotlight can index our new tags.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">[...]$ </span>./alternative-classifiers.py --db new.db --xattrs
</code></pre>
</div>

<p>Now it should be possible to find Clarifai-specific tags like <span class="clarifai">No Person</span> with Spotlight:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">[...]$ </span>mdfind <span class="s1">'tag:no person'</span>
.../Masters/2015/04/22/20150422-011045/IMG_0083.JPG
</code></pre>
</div>

<h3 id="note-adding-new-tags-to-photosapp">Note: Adding New Tags to Photos.app</h3>

<p>My last post on this subject showed how to extract tags from Photos.app, via a <code class="highlighter-rouge">TEXT</code> column in <code class="highlighter-rouge">photos.db</code> called <code class="highlighter-rouge">RKVersion_stringNote.value</code>. With this post, I had hoped it would be possible to do the reverse.</p>

<p>The obvious thing to try: appending to <code class="highlighter-rouge">RKVersion_stringNote.value</code>, and updating the plist where the list of categories is kept, doesn’t get the job done. Incomplete information and wishful thinking weren’t enough to get the job done :)</p>

<p>When the last post was discussed on Hacker News, several commentors pointed out how absurd this all is–that it should be trivial to retrieve and update information about your own photographs. I agree with them entirely.</p>

<p>(However, if you have a suggestion of how to solve this particular problem, <em>do</em> let me know!)</p>

<h3 id="conclusion">Conclusion</h3>

<p>Combining Clarifai’s tags with Apple’s has produced a marked improvement in the searchability of my Photo library.</p>

<p>I wonder if adding tags from additional services such as Rekognition, or Google Computer Vision would add as much value, or at what point adding another general model becomes redundant.</p>

<p><strong>Comment</strong> and <strong>Suggestion</strong> to <strong><a href="mailto:patrick.mcmurchie@gmail.com">patrick.mcmurchie@gmail.com</a></strong></p>

<script src="/assets/mac-photos-2/frequency.js"></script>

<script>
//activate('#coincidence', '/assets/mac-photos-2/blob.json', 1000, 1000);
freq_activate('#frequency-search', '/assets/mac-photos-2/freq.json');
</script>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p><a href="/notes/osx-photo-search">https://28mm.github.io/notes/osx-photo-search</a>&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>


</article>
<!--
<div class="page-navigation">
	
		<a class="home" href="/" title="Back to Homepage">Home</a>
  
		<span> &middot; </span>
    <a class="prev" href="/notes/d3-terraform-graphs-4" title="PREV: Exploring Terraform Graphs With D3.js Part 4">&gt;&gt;</a>
  
-->
</div>

		</main>

		<div class="footer">

<!-- begin social -->
<!--
<div class="container">
	<div class="row">
		<div class="span10 offset1">
			<div class="social-icons">
				<ul>
					<li><a href="https://facebook.com/patrick.mcmurchie"><i class="fa fa-facebook-official"></i></a></li>
					<li><a href="https://www.instagram.com/patrick.mcmurchie/"><i class="fa fa-instagram"></i></a></li>
					<li><a href="https://www.github.com/28mm"><i class="fa fa-github"></i></a></li>
<li><a href="mailto:patrick.mcmurchie@gmail.com"><i class="fa fa-envelope"></i></a></li>				

</ul>
			</div>
		</div>
	</div>
</div>
-->
<!--<div class="container">
<div class="row">-->
<img src="/assets/footer/junkyard.jpg" style="border-radius: 8px;">
<!--</div>
</div>-->

<!-- end social -->
  <span class="block ftr">&copy; 2018 <a href="/about">Patrick McMurchie</a></span>
</div>


	</body>

</html>
